<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Hand Simulator - Modern UI</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="/assets/modern-ui.css">

    <!-- Scripts -->
    <script type="module" src="./scripts/playhand-modern.mjs?v=18" defer></script>
    <script>
        // Mobile targeting toggle function (Phase 1: Mobile-First Layout)
        function toggleMobileTargeting() {
            const targetingControls = document.getElementById('targetingControls');
            const toggleButton = document.getElementById('mobileTargetingToggle');

            if (targetingControls.classList.contains('expanded')) {
                targetingControls.classList.remove('expanded');
                toggleButton.textContent = '🎯 Spell Targeting';
            } else {
                targetingControls.classList.add('expanded');
                toggleButton.textContent = '❌ Close Targeting';
            }
        }

        // Progressive Disclosure Functions (Phase 2)
        function setExpertiseLevel(level) {
            // Update active button
            document.querySelectorAll('.expertise-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-level') === level) {
                    btn.classList.add('active');
                }
            });

            // Update targeting controls container
            const targetingControls = document.getElementById('targetingControls');
            targetingControls.setAttribute('data-expertise', level);

            // Store preference
            localStorage.setItem('mtg-expertise-level', level);

            // Show appropriate toast message
            const messages = {
                'beginner': 'Beginner mode: Essential spells only',
                'advanced': 'Advanced mode: Basic + Advanced spells',
                'expert': 'Expert mode: All spells available'
            };

            if (window.handSimulator && window.handSimulator.showToast) {
                window.handSimulator.showToast(messages[level], 'info');
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');

            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                section.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }

        // Targeting Controls Toggle
        function toggleTargetingControls() {
            const targetingControls = document.getElementById('targetingControls');
            targetingControls.classList.toggle('expanded');
        }

        // Initialize progressive disclosure on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedLevel = localStorage.getItem('mtg-expertise-level') || 'beginner';
            setExpertiseLevel(savedLevel);

            // Make targeting header clickable
            const targetingHeader = document.querySelector('.targeting-header');
            if (targetingHeader) {
                targetingHeader.addEventListener('click', toggleTargetingControls);
            }
        });
    </script>
</head>
<body>
    <div class="app-container">
        <%- include('partials/nav-modern', { activePage: 'playhand' }); -%>

        <!-- Compact Top Control Bar -->
        <div class="play-controls-bar" role="toolbar" aria-label="Game Controls">
            <div class="controls-section">
                <div class="hand-controls" role="group" aria-label="Hand Actions">
                    <button id="drawHandButton" class="btn btn-primary-action" aria-describedby="draw-hand-desc">
                        <span aria-hidden="true">🎲</span> Draw Hand
                    </button>
                    <button id="endTurnButton" class="btn btn-primary-action" aria-describedby="end-turn-desc">
                        <span aria-hidden="true">⏭️</span> End Turn
                    </button>
                    <button id="mulligan" class="btn btn-secondary-action" aria-describedby="mulligan-desc">
                        <span aria-hidden="true">🔄</span> Mulligan
                    </button>
                    <button id="redrawHandButton" class="btn btn-secondary-action" onclick="window.handSimulator?.redrawHand()" title="Redraw 7 cards without penalty">
                        <span aria-hidden="true">🔁</span> Redraw
                    </button>
                    <button id="testCountersButton" class="btn btn-tertiary-action" aria-describedby="test-counters-desc">
                        <span aria-hidden="true">🧪</span> Test Counters
                    </button>
                    <button id="soundToggle" class="btn btn-tertiary-action" onclick="window.handSimulator?.toggleSounds()"
                            aria-describedby="sound-toggle-desc" aria-pressed="true">
                        <span aria-hidden="true">🔊</span> Sound
                    </button>
                </div>

                <!-- Targeting Toggle Button -->
                <button id="targetingToggleBtn" class="btn btn-secondary-action" onclick="toggleTargetingControls()">
                    🎯 Spells
                </button>

                <!-- Mobile Targeting Toggle (visible only on mobile) -->
                <button id="mobileTargetingToggle" class="btn btn-secondary-action mobile-only" style="display: none;" onclick="toggleMobileTargeting()">
                    🎯 Spell Targeting
                </button>

                <!-- Compact Spell Targeting -->
                <section class="targeting-controls" id="targetingControls">
                    <div class="compact-spell-bar">
                        <div class="expertise-toggle">
                            <button class="expertise-btn active" data-level="beginner" onclick="setExpertiseLevel('beginner')">📚</button>
                            <button class="expertise-btn" data-level="advanced" onclick="setExpertiseLevel('advanced')">⚡</button>
                            <button class="expertise-btn" data-level="expert" onclick="setExpertiseLevel('expert')">🎯</button>
                        </div>
                        <div class="spell-buttons" id="spellButtons">
                            <!-- Beginner spells -->
                            <button class="targeting-btn beginner-level" onclick="window.handSimulator?.lightningBolt()" title="Lightning Bolt">⚡</button>
                            <button class="targeting-btn beginner-level" onclick="window.handSimulator?.swordsToPlowshares()" title="Swords to Plowshares">⚔️</button>
                            <!-- Advanced spells -->
                            <button class="targeting-btn advanced-level" onclick="window.handSimulator?.shock()" title="Shock">💥</button>
                            <button class="targeting-btn advanced-level" onclick="window.handSimulator?.murder()" title="Murder">💀</button>
                            <button class="targeting-btn advanced-level" onclick="window.handSimulator?.terror()" title="Terror">😱</button>
                            <!-- Expert spells -->
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.unsummon()" title="Unsummon">🔄</button>
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.sleep()" title="Sleep">💤</button>
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.scry2()" title="Scry 2">🔮</button>
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.showSurveilUI('Surveil', 2, false)" title="Surveil 2">🔍</button>
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.ponder()" title="Ponder">🤔</button>
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.evolvingWilds()" title="Evolving Wilds">🌍</button>
                            <button class="targeting-btn expert-level" onclick="window.handSimulator?.scalding_tarn()" title="Scalding Tarn">🌋</button>
                        </div>
                    </div>
                </section>
            </div>

            <div class="controls-section">
                <div id="turnIndicator" class="turn-indicator">
                    <div class="turn-info">
                        <span class="turn-player">Your Turn</span>
                        <span class="turn-number">Turn 1</span>
                        <span class="turn-phase">Main Phase 1</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <label class="control-label">Deck:</label>
                <div class="deck-controls">
                    <div class="compact-deck-selector">
                        <select id="quickDeckSelect" class="form-select btn-sm">
                            <option value="">Select a deck...</option>
                            <option value="./decks/classic/affinity.xml">Affinity</option>
                            <option value="./xml/BigRedMachine.xml">Big Red Machine</option>
                            <option value="./xml/Stasis.xml">Stasis</option>
                            <option value="./decks/classic/goblins.xml">Goblins</option>
                            <option value="./decks/classic/dredge.xml">Dredge</option>
                            <option value="./decks/classic/hightide.xml">High Tide</option>
                        </select>
                        <button id="expandDeckSelector" class="btn btn-secondary btn-sm" title="More Decks">⋯</button>
                    </div>
                    <button id="loadXMLFileButton" class="btn btn-secondary btn-sm" title="Upload XML File">📁</button>
                    <input type="file" id="xmlFile" accept=".xml" style="display: none;">
                </div>
            </div>

            <div class="controls-section" style="border: 1px solid #d63384; border-radius: 4px; padding: 4px; margin-bottom: 4px;">
                <label class="control-label" style="font-weight: bold; color: #d63384; font-size: 11px;">🎯 OPPONENT CONTROLS:</label>
                <div class="deck-controls">
                    <div class="compact-deck-selector">
                        <select id="opponentDeckSelectTop" class="form-select btn-sm" onchange="window.handSimulator.loadOpponentDeck(this.value)">
                            <option value="">Select opponent deck...</option>

                            <!-- Featured Decks -->
                            <optgroup label="Featured Decks">
                                <option value="./xml/BigRedMachine.xml">Big Red Machine</option>
                                <option value="./xml/Stasis.xml">Stasis</option>
                                <option value="./decks/classic/affinity.xml">Affinity</option>
                                <option value="./decks/classic/goblins.xml">Goblins</option>
                            </optgroup>

                            <!-- Legacy Decks -->
                            <optgroup label="Legacy Decks">
                                <option value="./xml/legacy/Elves.xml">Elves</option>
                                <option value="./xml/legacy/Red-Delver.xml">Red Delver</option>
                                <option value="./decks/classic/hightide.xml">High Tide</option>
                                <option value="./decks/classic/belcher.xml">Belcher</option>
                                <option value="./decks/classic/dredge.xml">Dredge</option>
                                <option value="./decks/classic/landstill.xml">Landstill</option>
                            </optgroup>

                            <!-- Limited Decks -->
                            <optgroup label="Limited Decks">
                                <option value="./xml/Brothers_War/Limited-BrothersWar.xml">Brothers War Limited</option>
                                <option value="./xml/crimson_vow/Limited-Red.xml">Crimson Vow - Red</option>
                                <option value="./xml/crimson_vow/Limited-RedGreen.xml">Crimson Vow - RG</option>
                                <option value="./xml/crimson_vow/Limited-GreenBlack.xml">Crimson Vow - GB</option>
                                <option value="./xml/crimson_vow/Limited-WhiteSplash.xml">Crimson Vow - White</option>
                                <option value="./xml/crimson_vow/Limited-GreenBlue.xml">Crimson Vow - UG</option>
                                <option value="./xml/crimson_vow/Limited-GreenWhite.xml">Crimson Vow - GW</option>
                            </optgroup>

                            <!-- Casual Decks -->
                            <optgroup label="Casual Decks">
                                <option value="./xml/MulchandLoam.xml">Mulch and Loam</option>
                                <option value="./xml/BlackRack.xml">Black Rack</option>
                                <option value="./xml/BlackDread.xml">Black Dread</option>
                                <option value="./xml/BloodBraidElf.xml">Bloodbraid Elf</option>
                                <option value="./xml/BloodBraidEnchantress.xml">Bloodbraid Enchantress</option>
                                <option value="./xml/Brood.xml">Brood</option>
                                <option value="./xml/CharredDiscard.xml">Charred Discard</option>
                                <option value="./xml/Classic.xml">Classic</option>
                                <option value="./xml/Dimir_Inverter.xml">Dimir Inverter</option>
                                <option value="./xml/FireandIce.xml">Fire and Ice</option>
                                <option value="./xml/GreenWaste.xml">Green Waste</option>
                                <option value="./xml/GreenWasteOrder.xml">Green Waste Order</option>
                                <option value="./xml/GreenWasteTomorrow.xml">Green Waste Tomorrow</option>
                                <option value="./xml/GreenWasteSakura.xml">Green Waste Sakura</option>
                                <option value="./xml/WelderGamble.xml">Welder Gamble</option>
                                <option value="./xml/CloudpostWelder.xml">Cloudpost Welder</option>
                                <option value="./xml/JunkDiver.xml">Junk Diver</option>
                                <option value="./xml/JeskaiPioneer.xml">Jeskai Pioneer</option>
                                <option value="./xml/KindofBlue.xml">Kind of Blue</option>
                                <option value="./xml/IxalanCannons.xml">Ixalan Cannons</option>
                                <option value="./xml/Ixalan_BlackRedBlue.xml">Ixalan BRU</option>
                                <option value="./xml/Ixalan_Cannons_RedBlue.xml">Ixalan Cannons RU</option>
                                <option value="./xml/Ixalan_Green_White.xml">Ixalan GW</option>
                                <option value="./xml/Lumberjack.xml">Lumberjack</option>
                                <option value="./xml/MantisRiderPioneer.xml">Mantis Rider Pioneer</option>
                                <option value="./xml/Napoleon.xml">Napoleon</option>
                                <option value="./xml/Nishoba.xml">Nishoba</option>
                                <option value="./xml/Outpost.xml">Outpost</option>
                                <option value="./xml/PatriotBlock.xml">Patriot Block</option>
                                <option value="./xml/Patriot.xml">Patriot</option>
                                <option value="./xml/Pernicious.xml">Pernicious</option>
                                <option value="./xml/Plum.xml">Plum</option>
                                <option value="./xml/PlumGoneBlock.xml">Plum Gone Block</option>
                                <option value="./xml/RayneForest.xml">Rayne Forest</option>
                                <option value="./xml/RedPatrol.xml">Red Patrol</option>
                                <option value="./xml/Rith.xml">Rith</option>
                                <option value="./xml/TronTate.xml">Tron Tate</option>
                                <option value="./xml/Welder.xml">Welder</option>
                                <option value="./xml/ZombieRenewal.xml">Zombie Renewal</option>
                                <option value="./decks/classic/oath.xml">Oath</option>
                                <option value="./decks/classic/trix.xml">Trix</option>
                                <option value="./decks/classic/counterbalance.xml">Counterbalance</option>
                            </optgroup>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="window.handSimulator.drawOpponentHand(7)" title="Draw opponent hand (7 cards)" style="background-color: #d63384; border-color: #d63384; font-weight: bold;">
                        🎲 Draw Hand
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="window.handSimulator.mulliganOpponent()" title="Mulligan">
                        🔄 Mulligan
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="window.handSimulator.redrawOpponentHand()" title="Redraw 7 cards without penalty">
                        🔁 Redraw
                    </button>
                    <button class="btn btn-info btn-sm" onclick="window.handSimulator.setOpponentDeckAsDefault()" title="Set as default opponent deck">
                        ⭐ Set Default
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="window.handSimulator.clearDefaultOpponentDeck()" title="Clear default opponent deck">
                        ✕ Clear Default
                    </button>
                </div>
                <div class="text-xs text-muted">
                    <span id="opponentDeckNameTop">No Deck</span>
                </div>
            </div>

            <!-- Expandable deck selector (hidden by default) -->
            <div id="expandedDeckSelector" class="expanded-deck-selector" style="display: none;">
                <%- include('partials/decklist'); -%>
            </div>

            <div class="controls-section" style="border: 1px solid #0d6efd; border-radius: 4px; padding: 4px;">
                <label class="control-label" style="font-weight: bold; color: #0d6efd; font-size: 11px;">👤 YOUR LIBRARY CONTROLS:</label>
                <div class="deck-controls">
                    <button id="viewLibraryButton" class="btn btn-secondary btn-sm">
                        👁️ View Library (<span id="deckSize">0</span>)
                    </button>
                    <button id="shuffleLibraryButton" class="btn btn-secondary btn-sm" title="Shuffle Your Library">
                        🔀 Shuffle Library
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar (Simplified) -->
        <aside class="app-sidebar">
            <!-- Quick Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Game Stats</h3>
                </div>
                <div class="card-body p-3">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="cardsDrawn">0</div>
                            <div class="stat-label">Drawn</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="landsPlayed">0</div>
                            <div class="stat-label">Lands</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="spellsCast">0</div>
                            <div class="stat-label">Spells</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="turnNumber">1</div>
                            <div class="stat-label">Turn</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mana Counter -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">Mana Pool</h3>
                </div>
                <div class="card-body p-3">
                    <div class="mana-counters mb-3">
                        <div class="mana-row">
                            <button class="mana-btn" data-color="W" onclick="window.handSimulator.addMana('W')">⚪ <span id="manaW">0</span></button>
                            <button class="mana-btn" data-color="U" onclick="window.handSimulator.addMana('U')">🔵 <span id="manaU">0</span></button>
                            <button class="mana-btn" data-color="B" onclick="window.handSimulator.addMana('B')">⚫ <span id="manaB">0</span></button>
                        </div>
                        <div class="mana-row">
                            <button class="mana-btn" data-color="R" onclick="window.handSimulator.addMana('R')">🔴 <span id="manaR">0</span></button>
                            <button class="mana-btn" data-color="G" onclick="window.handSimulator.addMana('G')">🟢 <span id="manaG">0</span></button>
                            <button class="mana-btn" data-color="C" onclick="window.handSimulator.addMana('C')">💎 <span id="manaC">0</span></button>
                        </div>
                    </div>
                    <div class="mana-actions">
                        <button class="btn btn-secondary btn-sm" onclick="window.handSimulator.clearMana()">Clear All</button>
                        <button class="btn btn-primary btn-sm" onclick="window.handSimulator.tapLandsForMana()">Tap Lands</button>
                        <button class="btn btn-success btn-sm" onclick="window.handSimulator.untapAll()" title="Untap all permanents">
                            ↺ Untap All
                        </button>
                    </div>
                </div>
            </div>



            <!-- Library Search -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Search Library</h3>
                </div>
                <div class="card-body">
                    <select id="cardTypeFilter" class="form-input form-select">
                        <option value="">All Types</option>
                        <option value="Creatures">Creatures</option>
                        <option value="Spells">Instants & Sorceries</option>
                        <option value="Artifacts">Artifacts</option>
                        <option value="Enchantments">Enchantments</option>
                        <option value="Planeswalkers">Planeswalkers</option>
                        <option value="Land">Lands</option>
                    </select>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Loading State -->
            <div id="loadingState" class="card loading" style="display: none;">
                <div class="card-body text-center">
                    <div class="spinner mb-2"></div>
                    <div>Loading deck...</div>
                </div>
            </div>

            <!-- Two-Player Controls (Always Visible) -->
            <div class="card mb-4" style="border: 2px solid var(--primary); background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));">
                <div class="card-body p-3">
                    <div class="d-flex gap-2 align-items-center mb-3">
                        <span class="text-muted font-weight-bold">Active Player:</span>
                        <button id="switchToPlayer" class="btn btn-primary btn-sm" onclick="window.handSimulator?.switchToPlayer()">
                            🧙‍♂️ You
                        </button>
                        <button id="switchToOpponent" class="btn btn-secondary btn-sm" onclick="window.handSimulator?.switchToOpponent()">
                            👤 Opponent
                        </button>
                    </div>

                    <!-- Active Player Context Indicator -->
                    <div id="activePlayerIndicator" class="player-context player" style="
                        padding: var(--space-2) var(--space-3);
                        background: var(--primary);
                        color: white;
                        border-radius: var(--border-radius);
                        text-align: center;
                        font-weight: bold;
                        margin-bottom: var(--space-2);
                    ">
                        Controlling: You
                    </div>

                    <!-- Two-Player Game Controls -->
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-success btn-xs" onclick="window.handSimulator?.quickTwoPlayerSetup()" title="Quick setup with default decks">
                            ⚡ Quick Setup
                        </button>
                        <button class="btn btn-warning btn-xs" onclick="window.handSimulator?.startTwoPlayerGame()" title="Start structured turn-based game">
                            🎮 Start Game
                        </button>
                        <button class="btn btn-info btn-xs" onclick="window.handSimulator?.passTurn()" title="Pass turn to other player">
                            ↻ Pass Turn
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="card">
                <div class="card-body text-center">
                    <div class="text-muted mb-4">
                        <span style="font-size: 3rem;">🎮</span>
                    </div>
                    <h2 class="mb-2">MTG Hand Simulator</h2>
                    <p class="text-muted mb-4">
                        Select a deck to start simulating, or use <strong>Quick Setup</strong> above for instant two-player testing.
                    </p>
                    <div class="d-flex gap-4 justify-content-center">
                        <button onclick="document.querySelector('.deck-search-input')?.focus()"
                                class="btn btn-primary">
                            Choose Pre-defined Deck
                        </button>
                        <button onclick="document.getElementById('loadXMLFileButton').click()"
                                class="btn btn-secondary">
                            Upload Deck File
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Content -->
            <div id="gameContent" style="display: none;">
                <!-- Two-Player Layout for Wide Screens -->
                <div class="two-player-layout" style="display: none;">
                    <!-- Opponent Area (Left Side) -->
                    <div class="player-area" id="opponentArea">
                        <div class="player-header">
                            <div class="player-info">
                                <div>
                                    <h2>👤 Opponent</h2>
                                    <div class="text-sm text-muted">
                                        Hand: <span id="opponentHandCount2">0</span> cards •
                                        Deck: <span id="opponentDeckName2">No Deck</span>
                                    </div>
                                </div>
                                <div class="life-display" id="opponentLife2">20</div>
                            </div>
                            <div class="player-controls">
                                <button class="btn btn-sm btn-success" onclick="window.handSimulator.changeOpponentLife(1)">+1</button>
                                <button class="btn btn-sm btn-danger" onclick="window.handSimulator.changeOpponentLife(-1)">-1</button>
                                <button class="btn btn-sm btn-primary" onclick="window.handSimulator.drawOpponentCard()">Draw</button>
                            </div>
                        </div>
                        <div class="player-zones">
                            <div class="hand-area">
                                <div class="zone-title">🃏 Hand</div>
                                <div id="opponentHandContainer2" class="zone-content"></div>
                            </div>
                            <div class="battlefield-area">
                                <div class="zone-section">
                                    <div class="zone-title">🏔️ Lands</div>
                                    <div id="opponentBattlefieldLands2" class="zone-content"></div>
                                </div>
                                <div class="zone-section">
                                    <div class="zone-title">⚔️ Creatures</div>
                                    <div id="opponentBattlefieldCreatures2" class="zone-content"></div>
                                </div>
                                <div class="zone-section">
                                    <div class="zone-title">✨ Other Permanents</div>
                                    <div id="opponentBattlefieldOthers2" class="zone-content"></div>
                                </div>
                            </div>
                            <div class="graveyard-exile-area">
                                <button class="zone-counter btn btn-sm btn-outline-secondary" onclick="window.handSimulator.showOpponentGraveyardModal()" title="Click to view opponent graveyard">
                                    🪦 Graveyard: <span id="opponentGraveyardCount2">0</span>
                                </button>
                                <button class="zone-counter btn btn-sm btn-outline-secondary" onclick="window.handSimulator.showOpponentExileModal()" title="Click to view opponent exile">
                                    🚫 Exile: <span id="opponentExileCount2">0</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Player Area (Right Side) -->
                    <div class="player-area active" id="playerArea">
                        <div class="player-header">
                            <div class="player-info">
                                <div>
                                    <h2>🧙‍♂️ You</h2>
                                    <div class="text-sm text-muted">
                                        <span id="handCount2">0 cards</span> •
                                        <span id="mulliganCount2">0 mulligans</span>
                                    </div>
                                </div>
                                <div class="life-display" id="lifeTotal2">20</div>
                            </div>
                            <div class="player-controls">
                                <button class="btn btn-sm btn-success" onclick="window.handSimulator.changeLife(1)">+1</button>
                                <button class="btn btn-sm btn-danger" onclick="window.handSimulator.changeLife(-1)">-1</button>
                                <button class="btn btn-sm btn-primary" onclick="window.handSimulator.drawCard()">Draw</button>
                            </div>
                        </div>
                        <div class="player-zones">
                            <div class="hand-area">
                                <div class="zone-title">🃏 Your Hand</div>
                                <div id="handContainer2" class="zone-content"></div>
                            </div>
                            <div class="battlefield-area">
                                <div class="zone-section">
                                    <div class="zone-title">🏔️ Lands</div>
                                    <div id="battlefieldLands2" class="zone-content"></div>
                                </div>
                                <div class="zone-section">
                                    <div class="zone-title">⚔️ Creatures</div>
                                    <div id="battlefieldCreatures2" class="zone-content"></div>
                                </div>
                                <div class="zone-section">
                                    <div class="zone-title">✨ Other Permanents</div>
                                    <div id="battlefieldOthers2" class="zone-content"></div>
                                </div>
                            </div>
                            <div class="graveyard-exile-area">
                                <button class="zone-counter btn btn-sm btn-outline-secondary" onclick="window.handSimulator.showGraveyardModal()" title="Click to view graveyard">
                                    🪦 Graveyard: <span id="graveyardCount2">0</span>
                                </button>
                                <button class="zone-counter btn btn-sm btn-outline-secondary" onclick="window.handSimulator.showExileModal()" title="Click to view exile">
                                    🚫 Exile: <span id="exileCount2">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Original Single-Player Layout -->
                <div class="single-player-layout">

                <!-- Opponent Section -->
                <div id="opponentSection" class="card mb-4">
                    <div class="card-header">
                        <h2 class="card-title">👤 Opponent</h2>
                        <div class="card-subtitle">
                            Life: <span id="opponentLife">20</span> •
                            Hand: <span id="opponentHandCount">0</span> cards
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Opponent Battlefield -->
                        <div class="mb-3">
                            <h4 class="text-sm font-weight-bold mb-2">⚔️ Opponent's Battlefield</h4>
                            <div class="battlefield-zones">
                                <div class="mb-2">
                                    <span class="text-xs">🏔️ Lands:</span>
                                    <div id="opponentBattlefieldLands" class="d-flex gap-1 flex-wrap" style="min-height: 40px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                        <!-- Opponent lands will appear here -->
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <span class="text-xs">⚔️ Creatures:</span>
                                    <div id="opponentBattlefieldCreatures" class="d-flex gap-1 flex-wrap" style="min-height: 40px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                        <!-- Opponent creatures will appear here -->
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <span class="text-xs">✨ Others:</span>
                                    <div id="opponentBattlefieldOthers" class="d-flex gap-1 flex-wrap" style="min-height: 40px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                        <!-- Opponent other permanents will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Opponent Zones -->
                        <div class="d-flex gap-2">
                            <span class="badge">🪦 Graveyard: <span id="opponentGraveyardCount">0</span></span>
                            <span class="badge">🚫 Exile: <span id="opponentExileCount">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Current Hand -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title">Your Hand</h2>
                            <div class="card-subtitle">
                                <span id="handCount">0 cards</span> •
                                <span id="mulliganCount">0 mulligans</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="sortHandButton" class="btn btn-secondary btn-sm">🔄 Sort Hand</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="handContainer">
                            <!-- Hand cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Game Areas Grid -->
                <div class="card-grid mb-4" style="grid-template-columns: 1fr 1fr;">
                    <!-- Battlefield -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">⚔️ Battlefield</h3>
                            <div class="card-subtitle">
                                Permanents in play
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h4 class="text-sm font-weight-bold mb-2">🏔️ Lands</h4>
                                <div id="battlefieldLands" class="d-flex gap-2 flex-wrap" style="min-height: 60px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                    <!-- Battlefield lands will appear here -->
                                </div>
                            </div>
                            <div class="mb-3">
                                <h4 class="text-sm font-weight-bold mb-2">⚔️ Creatures</h4>
                                <div id="battlefieldCreatures" class="d-flex gap-2 flex-wrap" style="min-height: 60px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                    <!-- Battlefield creatures will appear here -->
                                </div>
                            </div>
                            <div>
                                <h4 class="text-sm font-weight-bold mb-2">✨ Other Permanents</h4>
                                <div id="battlefieldOthers" class="d-flex gap-2 flex-wrap" style="min-height: 60px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                    <!-- Other permanents will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zones -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex gap-2 mb-2">
                                <button class="btn btn-sm zone-tab active" data-zone="graveyard">
                                    🪦 Graveyard (<span id="graveyardCount">0</span>)
                                </button>
                                <button class="btn btn-sm zone-tab" data-zone="exile">
                                    🚫 Exile (<span id="exileCount">0</span>)
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-xs btn-secondary" onclick="window.handSimulator?.addTestCardToGraveyard()" title="Add test card to graveyard">
                                    +Test GY
                                </button>
                                <button class="btn btn-xs btn-secondary" onclick="window.handSimulator?.addTestCardToExile()" title="Add test card to exile">
                                    +Test Exile
                                </button>
                                <button class="btn btn-xs btn-success" onclick="window.handSimulator?.addTestCreatureWithCounters()" title="Add test creature with counters">
                                    +Test Creature
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="graveyardZone" class="zone-content" style="min-height: 200px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                <!-- Graveyard cards will appear here -->
                            </div>
                            <div id="exileZone" class="zone-content" style="display: none; min-height: 200px; padding: var(--space-2); background-color: var(--bg-tertiary); border-radius: var(--border-radius);">
                                <!-- Exile cards will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- End single-player-layout -->

            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-overlay" onclick="document.body.classList.remove('mobile-sidebar-open')"></div>
    <nav class="mobile-nav-bottom">
        <div class="mobile-nav-tabs">
            <a href="/decks-modern" class="mobile-nav-tab">
                <span class="mobile-nav-icon">🃏</span>
                <span>Decks</span>
            </a>
            <a href="/playhand-modern" class="mobile-nav-tab active">
                <span class="mobile-nav-icon">🎮</span>
                <span>Play</span>
            </a>
            <a href="/handsimulation" class="mobile-nav-tab">
                <span class="mobile-nav-icon">🎲</span>
                <span>Simulate</span>
            </a>
            <a href="/alldecks" class="mobile-nav-tab">
                <span class="mobile-nav-icon">📚</span>
                <span>Library</span>
            </a>
            <a href="/create-deck-form" class="mobile-nav-tab">
                <span class="mobile-nav-icon">➕</span>
                <span>Create</span>
            </a>
        </div>
    </nav>

    <!-- Library Modal -->
    <div id="libraryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Library Contents</h3>
                <button id="closeLibraryModal" class="btn btn-secondary btn-sm">✕</button>
            </div>
            <div class="modal-body">
                <div id="libraryContents" class="d-flex flex-column gap-2" style="max-height: 400px; overflow-y: auto;">
                    <!-- Library cards will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="fabButton" class="fab" title="Quick Actions">
        ⚡
    </button>

    <!-- Card Preview Modal -->
    <div id="cardPreviewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="previewCardName">Card Preview</h3>
                <button id="closeCardPreview" class="btn btn-secondary btn-sm">✕</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <img id="previewCardImage" src="" alt="Card Preview" style="max-width: 100%; border-radius: var(--border-radius);">
                <div id="previewCardInfo" style="margin-top: var(--space-4); text-align: left;">
                    <!-- Card details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Graveyard Modal -->
    <div id="graveyardModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>🪦 Graveyard</h3>
                <button id="closeGraveyardModal" class="btn btn-secondary btn-sm">✕</button>
            </div>
            <div class="modal-body">
                <div id="graveyardModalContents" class="d-flex flex-wrap gap-2" style="max-height: 400px; overflow-y: auto;">
                    <!-- Graveyard cards will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Exile Modal -->
    <div id="exileModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>🚫 Exile</h3>
                <button id="closeExileModal" class="btn btn-secondary btn-sm">✕</button>
            </div>
            <div class="modal-body">
                <div id="exileModalContents" class="d-flex flex-wrap gap-2" style="max-height: 400px; overflow-y: auto;">
                    <!-- Exile cards will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Card Zoom Overlay -->
    <div id="cardZoomOverlay" class="card-zoom-overlay">
        <div class="card-zoom-container">
            <img id="cardZoomImage" class="card-zoom-image" src="" alt="Card Preview">
            <button id="cardZoomClose" class="card-zoom-close" aria-label="Close card preview">✕</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>
</body>
</html>